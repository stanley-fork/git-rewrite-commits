#!/bin/sh
#
# Git post-commit hook to optionally improve commit messages
# 
# Installation:
#   1. Copy this file to .git/hooks/post-commit
#   2. Make it executable: chmod +x .git/hooks/post-commit
#   3. Enable it: git config hooks.postCommitRewrite true
#
# This hook will:
# - Run after each commit ONLY if explicitly enabled
# - Improve the last commit message using AI
# - Skip if the message is already well-formed
# - Always create a backup before rewriting

# Check if post-commit rewrite is enabled (opt-in)
ENABLED=$(git config --get --type=bool hooks.postCommitRewrite)
if [ "$ENABLED" != "true" ]; then
    # Not enabled, exit silently
    exit 0
fi

# Determine AI provider (via environment variable or git config)
PROVIDER="${GIT_COMMIT_PROVIDER:-$(git config --get hooks.commitProvider)}"
PROVIDER="${PROVIDER:-openai}"  # Default to OpenAI

# Check if provider is properly configured
if [ "$PROVIDER" = "openai" ] && [ -z "$OPENAI_API_KEY" ]; then
    echo "âš ï¸  OPENAI_API_KEY not set, skipping commit message improvement"
    echo "   Or configure Ollama: git config hooks.commitProvider ollama"
    exit 0
fi

# Check if we're in a rebase or merge
if [ -d "$(git rev-parse --git-dir)/rebase-merge" ] || [ -d "$(git rev-parse --git-dir)/rebase-apply" ]; then
    exit 0
fi

# Improve the last commit message (always with backup, never with --skip-backup)
# --skip-remote-consent is used because hooks run non-interactively
# User must explicitly enable hook (opt-in) via git config
echo "ðŸ¤– Improving commit message using $PROVIDER..."
npx git-rewrite-commits \
    --provider "$PROVIDER" \
    --max-commits 1 \
    --skip-remote-consent \
    --quiet \
    2>/dev/null || true

echo "âœ¨ Commit message improved!"

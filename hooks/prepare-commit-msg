#!/bin/sh
#
# Git prepare-commit-msg hook to suggest better commit messages
#
# Installation:
#   1. Copy this file to .git/hooks/prepare-commit-msg
#   2. Make it executable: chmod +x .git/hooks/prepare-commit-msg
#   3. Enable it: git config hooks.prepareCommitMsg true
#
# This hook will:
# - Analyze your staged changes (opt-in only)
# - Generate an AI-powered commit message
# - Insert it as the default message (you can edit before saving)
#
# âš ï¸  PRIVACY NOTICE:
# This hook sends your staged changes to an AI provider (OpenAI by default).
# Use --provider ollama for local processing without remote API calls.

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# Check if pre-commit already generated a message that was approved
TEMP_MSG_FILE="${GIT_DIR:-.git}/.ai-commit-message.tmp"

# Special handling for -m flag with pre-commit suggestion
if [ "$COMMIT_SOURCE" = "message" ] && [ -f "$TEMP_MSG_FILE" ]; then
    # User used -m but approved a better message in pre-commit
    # Replace the -m message with the AI suggestion
    AI_MESSAGE=$(cat "$TEMP_MSG_FILE")
    rm -f "$TEMP_MSG_FILE"
    
    # Override the original message with AI suggestion
    # Note: Don't add comment lines as they won't be stripped with -m flag
    echo "$AI_MESSAGE" > "$COMMIT_MSG_FILE"
    exit 0
fi

# Skip processing for other non-normal commits
# But NOT for "message" if we don't have a temp file
if [ -n "$COMMIT_SOURCE" ] && [ "$COMMIT_SOURCE" != "message" ]; then
    # Clean up any temp message from pre-commit
    rm -f "$TEMP_MSG_FILE"
    exit 0
fi

# For normal commits or -m without pre-commit suggestion
if [ "$COMMIT_SOURCE" = "message" ]; then
    # User provided -m and no pre-commit suggestion exists
    # Just use their message as-is
    exit 0
fi

# Only process for normal commits without -m flag
if [ -z "$COMMIT_SOURCE" ]; then
    # Check if prepare-commit-msg is enabled (opt-in required)
    ENABLED=$(git config --get --type=bool hooks.prepareCommitMsg)
    if [ "$ENABLED" != "true" ]; then
        # Clean up any temp message from pre-commit
        rm -f "${GIT_DIR:-.git}/.ai-commit-message.tmp"
        # Not enabled, add helpful hint
        echo "# Tip: Enable AI commit messages with: git config hooks.prepareCommitMsg true" > "$COMMIT_MSG_FILE.tmp"
        echo "# Or use Ollama locally: git config hooks.commitProvider ollama" >> "$COMMIT_MSG_FILE.tmp"
        echo "# âš ï¸  Note: This will send staged changes to an AI provider" >> "$COMMIT_MSG_FILE.tmp"
        echo "" >> "$COMMIT_MSG_FILE.tmp"
        cat "$COMMIT_MSG_FILE" >> "$COMMIT_MSG_FILE.tmp"
        mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
        exit 0
    fi

    # Determine AI provider (via environment variable or git config)
    PROVIDER="${GIT_COMMIT_PROVIDER:-$(git config --get hooks.commitProvider)}"
    PROVIDER="${PROVIDER:-openai}"  # Default to OpenAI
    
    # Check if provider is properly configured
    if [ "$PROVIDER" = "openai" ] && [ -z "$OPENAI_API_KEY" ]; then
        # Add a helpful comment if API key is not set
        echo "# Tip: Set OPENAI_API_KEY to get AI-generated commit messages" > "$COMMIT_MSG_FILE.tmp"
        echo "# Or use Ollama: git config hooks.commitProvider ollama" >> "$COMMIT_MSG_FILE.tmp"
        echo "" >> "$COMMIT_MSG_FILE.tmp"
        cat "$COMMIT_MSG_FILE" >> "$COMMIT_MSG_FILE.tmp"
        mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
        exit 0
    fi

    # Check if there are staged changes
    if ! git diff --cached --quiet; then
        # Check if pre-commit already generated a message
        if [ -f "$TEMP_MSG_FILE" ]; then
            # Use the message from pre-commit hook
            echo "âœ¨ Using AI message from pre-commit preview..." >&2
            AI_MESSAGE=$(cat "$TEMP_MSG_FILE")
            # Clean up temp file
            rm -f "$TEMP_MSG_FILE"
        else
            # Generate AI-powered commit message
            echo "ðŸ¤– Generating AI-powered commit message..." >&2
            
            # Securely build arguments array to prevent shell injection
            # Note: We do NOT use eval or string concatenation with user input
            # --skip-remote-consent is used because hooks run non-interactively
            # User must explicitly enable hook (opt-in) via git config
            
            # Try to use locally installed version first, otherwise use npx
            if command -v git-rewrite-commits >/dev/null 2>&1; then
                set -- git-rewrite-commits --staged --quiet --provider "$PROVIDER" --skip-remote-consent
            else
                set -- npx git-rewrite-commits --staged --quiet --provider "$PROVIDER" --skip-remote-consent
            fi
            
            # Add model if configured (via environment variable or git config)
            MODEL="${GIT_COMMIT_MODEL:-$(git config --get hooks.providerModel)}"
            if [ -n "$MODEL" ]; then
                set -- "$@" --model "$MODEL"
            fi
            
            # Add template if configured (via environment variable or git config)
            TEMPLATE="${GIT_COMMIT_TEMPLATE:-$(git config --get hooks.commitTemplate)}"
            if [ -n "$TEMPLATE" ]; then
                set -- "$@" --template "$TEMPLATE"
            fi
            
            # Add language if configured (via environment variable or git config)
            LANGUAGE="${GIT_COMMIT_LANGUAGE:-$(git config --get hooks.commitLanguage)}"
            if [ -n "$LANGUAGE" ]; then
                set -- "$@" --language "$LANGUAGE"
            fi
            
            # Generate the message using the tool with properly quoted arguments
            AI_MESSAGE=$("$@" 2>/dev/null)
        fi
        
        # Use the AI message if we have one
        if [ -n "$AI_MESSAGE" ]; then
            # Success! Use the AI-generated message
            cat > "$COMMIT_MSG_FILE" << EOF
$AI_MESSAGE

# âœ¨ AI-generated commit message above
# Feel free to edit as needed before saving
# 
# Files being committed:
$(git diff --cached --name-status | sed 's/^/# /')
EOF
        else
            # Fallback if generation fails
            cat > "$COMMIT_MSG_FILE.tmp" << EOF
# ðŸ’¡ Tip: AI message generation failed. Writing your own message.
# 
# Consider using conventional commit format:
#   feat: add new feature
#   fix: fix a bug
#   docs: documentation changes
#   style: formatting changes
#   refactor: code restructuring
#   test: add or update tests
#   chore: maintenance tasks
#
# Files being committed:
$(git diff --cached --name-status | sed 's/^/# /')

$(cat "$COMMIT_MSG_FILE")
EOF
            mv "$COMMIT_MSG_FILE.tmp" "$COMMIT_MSG_FILE"
        fi
    fi
fi

exit 0

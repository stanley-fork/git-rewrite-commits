#!/bin/sh
#
# Git pre-push hook to review and fix commit messages before pushing
#
# Installation:
#   1. Copy this file to .git/hooks/pre-push
#   2. Make it executable: chmod +x .git/hooks/pre-push
#
# This hook will:
# - Show you which commits need improvement before pushing
# - Ask for confirmation before making changes
# - Only process unpushed commits

# Determine AI provider (via environment variable or git config)
PROVIDER="${GIT_COMMIT_PROVIDER:-$(git config --get hooks.commitProvider)}"
PROVIDER="${PROVIDER:-openai}"  # Default to OpenAI

# Check if provider is properly configured
if [ "$PROVIDER" = "openai" ] && [ -z "$OPENAI_API_KEY" ]; then
    echo "‚ö†Ô∏è  OPENAI_API_KEY not set, skipping commit message check"
    echo "   Or configure Ollama: git config hooks.commitProvider ollama"
    exit 0
fi

# Get the remote and branch
remote="$1"
url="$2"

# Count unpushed commits
unpushed=$(git rev-list @{u}..HEAD --count 2>/dev/null || echo "0")

if [ "$unpushed" -eq "0" ]; then
    exit 0
fi

echo "üîç Checking $unpushed unpushed commit(s) for quality..."
echo ""

# First, do a dry run to show what would change
# Note: dry-run mode still requires consent check (not --skip-remote-consent)
npx git-rewrite-commits --provider "$PROVIDER" --max-commits "$unpushed" --dry-run

# Ask for confirmation
echo ""
echo "Would you like to apply these improvements before pushing? (y/n)"
read -r answer < /dev/tty

if [ "$answer" = "y" ] || [ "$answer" = "yes" ]; then
    echo "üìù Improving commit messages using $PROVIDER..."
    # Always create backup, never use --skip-backup
    # Consent is given interactively by answering 'y' above
    npx git-rewrite-commits --provider "$PROVIDER" --max-commits "$unpushed"
    echo "‚úÖ Commit messages improved! Continuing with push..."
else
    echo "‚è≠Ô∏è  Skipping improvements, continuing with original messages..."
fi

exit 0
